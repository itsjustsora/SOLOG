# Outbox 패턴과 이벤트 신뢰성

## 날짜
- 2026-02-13

## 🎯 오늘의 주제
- 이벤트 유실이 왜 문제가 되는지 이해
- DB 트랜잭션과 메시지 발행이 분리될 때 발생하는 정합성 문제 정리
- Outbox 패턴의 핵심 아이디어 이해

---

## 1. 이벤트 유실이 왜 문제가 되는가

MSA 환경에서는 서비스 간 직접 호출 대신 이벤트 기반 통신을 사용하는 경우가 많다. 한 서비스가 자신의 DB에 상태를 저장한 뒤 이벤트를 발행하고, 다른 서비스는 그 이벤트를 기준으로 후속 작업을 수행한다. 이 구조에서는 이벤트가 단순한 메시지가 아니라 다음 비즈니스 흐름을 시작시키는 신호 역할을 한다.

문제는 이벤트가 유실될 경우다. 데이터는 이미 저장되었지만 다른 서비스는 이를 알지 못하고, 그 결과 후속 처리가 수행되지 않는다. 이는 단순한 메시지 손실이 아니라 비즈니스 흐름의 단절로 이어질 수 있다. 특히 정산, 리스크 분석, 알림과 같은 비동기 후속 처리 영역에서는 이벤트 유실이 곧 기능 미동작으로 연결된다.

---

## 2. DB 트랜잭션과 메시지 발행의 분리 문제

일반적인 구현은 다음과 같은 순서를 따른다. 먼저 DB에 상태를 저장하고 커밋한 뒤, 메시지 브로커에 이벤트를 발행한다. 이 두 작업은 서로 다른 시스템에 의존하기 때문에 하나의 원자적 작업으로 묶이지 않는다.

이로 인해 다음과 같은 상황이 발생할 수 있다.

- DB는 성공했지만 MQ 발행은 실패
- DB는 롤백되었지만 이벤트는 이미 발행됨
- 네트워크 장애로 발행 성공 여부가 불확실

이 문제의 본질은 DB 트랜잭션과 메시지 발행이 서로 다른 책임 영역에 있다는 점이다. 따라서 기술적으로는 정합성을 강제할 방법이 없다. 그 결과 DB는 성공했지만 이벤트는 실패한 상태가 실제로 발생할 수 있다.

---

## 3. Outbox 패턴의 핵심 아이디어

Outbox 패턴은 이 문제를 줄이기 위한 설계 전략이다. 핵심은 이벤트를 즉시 MQ로 보내지 않고, 같은 DB 트랜잭션 안에 함께 기록하는 것이다. 즉, 비즈니스 데이터와 이벤트 레코드를 동일한 트랜잭션 안에서 저장한다.

동작 흐름은 다음과 같다.

1. 도메인 데이터 저장
2. Outbox 테이블에 이벤트 데이터 저장
3. 트랜잭션 커밋
4. 별도의 프로세스가 Outbox 테이블을 읽어 MQ로 발행
5. 발행 성공 시 Outbox 상태 업데이트

이 구조에서는 최소한 비즈니스 데이터 저장과 이벤트 기록이 함께 성공하거나 함께 실패한다. 이벤트 발행은 비동기적으로 처리되지만, 유실 가능성은 크게 줄어든다.

---

## 4. 설계 시 고려해야 할 점

Outbox를 도입한다고 해서 문제가 완전히 사라지는 것은 아니다. 이벤트 중복 발행 가능성은 여전히 존재하며, 이를 수신 측에서 멱등하게 처리해야 한다. 또한 Polling 방식인지 CDC(Change Data Capture) 방식인지에 따라 구현 복잡도와 운영 전략이 달라진다.

Outbox 테이블은 지속적으로 쌓이기 때문에 정리 전략도 필요하다. 재처리 정책, 장애 복구 시 처리 순서 보장, 발행 실패 시 재시도 방식 등도 함께 설계해야 한다.

Outbox는 Exactly-once를 보장하는 기술이 아니라, 이벤트 유실 확률을 구조적으로 낮추는 전략에 가깝다.

> **💡 중간 설명 | Polling과 CDC**
> 
> Outbox 테이블을 MQ로 전달하는 방식은 보통 Polling 방식과 CDC 방식으로 나뉜다. Polling은 애플리케이션이 주기적으로 테이블을 조회하는 방식이고, CDC는 DB 로그를 기반으로 변경 내용을 스트리밍하는 방식이다. 두 방식은 구현 복잡도와 운영 전략에서 차이가 있다.
---

## 5. 도메인 관점에서의 점검

이벤트 기반 설계를 하고 있다면 다음 질문을 스스로 점검해볼 필요가 있다.

- 특정 이벤트가 발행되지 않으면 어떤 기능이 멈추는가?
- DB는 성공했지만 이벤트는 실패했을 때 이를 감지할 수 있는가?
- 이벤트가 중복 발행되더라도 시스템은 안전한가?

Outbox 패턴은 두 번째 질문에 대한 현실적인 해법이다.

---

## 6. 정리

이벤트 기반 구조에서는 DB 저장과 메시지 발행이 서로 다른 시스템에 의존하기 때문에 정합성 문제가 발생할 수 있다. Outbox 패턴은 비즈니스 데이터와 이벤트를 동일한 DB 트랜잭션 안에 기록함으로써 이벤트 유실 가능성을 줄인다. 완전한 정합성을 보장하는 방법은 아니지만, 분산 환경에서 이벤트 신뢰성을 확보하기 위한 실용적인 접근 방식이다.
