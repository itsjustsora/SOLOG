# 메시지 전달 보장 수준과 Exactly-once의 구조적 한계

## 날짜
- 2026-02-14

## 🎯 오늘의 주제
- At-most-once / At-least-once / Exactly-once 개념
- 네트워크와 재시도가 만드는 중복 문제
- Exactly-once가 구조적으로 어려운 이유

---

## 1. 메시지 전달 보장 수준의 기본 개념

분산 시스템에서 메시지를 전달할 때 가장 중요한 질문은 이 메시지가 몇 번 처리되는가이다. 메시지 브로커는 보통 세 가지 수준 중 하나의 전달 보장을 제공한다.

1. **At-most-once**  
   메시지가 최대 한 번 처리되는 모델이다. 중복은 발생하지 않지만 실패 시 메시지가 유실될 수 있다. 재시도를 하지 않거나, 일부 유실을 허용하는 경우에 선택된다.

2. **At-least-once**  
   메시지가 최소 한 번은 처리되는 모델이다. 메시지 유실을 방지하기 위해 재시도를 허용하며, 그 결과 동일 메시지가 여러 번 전달될 수 있다. 대부분의 실무 환경은 이 모델을 기반으로 동작한다.

3. **Exactly-once**  
   메시지가 정확히 한 번만 처리되는 것을 의미한다. 유실도 없고 중복도 없는 이상적인 모델이지만, 분산 환경에서는 구현 난이도가 매우 높다.

여기서 한 가지 구분해야 할 점이 있다. 브로커가 보장하는 것은 메시지 전달 수준이며, 비즈니스 관점에서 중요한 것은 실제 처리 결과가 몇 번 반영되었는가이다. 전달이 `At-least-once`라 하더라도, 처리 로직을 멱등하게 설계하면 비즈니스 관점에서는 `Exactly-once`에 가깝게 동작하도록 만들 수 있다.

---

## 2. 왜 네트워크가 문제를 만드는가

분산 시스템에서는 메시지 처리와 그에 대한 확인(ACK)이 서로 다른 시스템 경계를 넘는다. 소비자가 메시지를 받아 DB에 반영한 뒤 ACK를 보내는 구조라면, 이 두 작업 사이에 장애가 발생할 수 있다.

**예시**
- DB 반영은 성공했지만 ACK 전송이 실패하면, 브로커는 해당 메시지를 다시 전달한다.
- 이 경우 동일 메시지가 두 번 처리된다. 
- 반대로 DB 반영은 실패했지만 ACK가 먼저 성공하면 메시지는 유실된다.

이처럼 처리 완료와 확인 전송 사이의 작은 틈이 `Exactly-once`를 어렵게 만드는 핵심 원인이다. 문제는 특정 브로커의 기능이 아니라, 네트워크 경계와 비동기 통신이라는 구조 자체에 있다.

---

## 3. DB 트랜잭션과 메시지 처리의 분리

메시지 소비 로직은 보통 다음 단계를 따른다. 

1. 메시지 수신
2. 비즈니스 로직 수행
3. DB 반영
4. ACK 전송

여기서 DB는 자체 트랜잭션을 사용하고, 메시지 브로커는 별도의 전달 메커니즘을 가진다. 이 두 시스템은 동일한 원자적 경계 안에 존재하지 않는다.

`Exactly-once`를 완전하게 보장하려면 메시지 소비와 DB 반영이 하나의 원자적 경계로 묶여야 한다. 그러나 Producer, Broker, Consumer, Database가 서로 다른 시스템으로 분리되어 있는 이상 이를 전역적으로 강제하는 것은 현실적으로 매우 어렵다. 이는 단순한 메시지 브로커의 문제가 아니라 시스템 전체 설계 문제에 가깝다.

또한 메시지 시스템에서는 중복뿐 아니라 순서 보장도 중요한 이슈가 된다. 상태 전이가 순서에 의존하는 도메인에서는 메시지 순서가 뒤바뀌는 것 역시 정합성 문제로 이어질 수 있다. 따라서 전달 보장은 중복 여부만의 문제가 아니다.

---

## 4. 실무에서의 선택: 유실보다 중복

실무에서는 메시지 유실을 더 위험하게 본다. 유실은 비즈니스 흐름을 멈추게 만들지만, 중복은 설계로 제어 가능하다고 판단한다. 그래서 많은 시스템이 `At-least-once` 모델을 선택하고, 중복 처리를 애플리케이션 레벨에서 해결한다.

이때 핵심은 `멱등성`이다. 동일 메시지가 여러 번 들어와도 결과가 한 번 처리한 것과 동일해야 한다. 이벤트 ID 기반 중복 체크, 상태 전이 조건 검증, 이미 처리된 요청 무시 전략 등이 여기에 해당한다. 상태 기반 설계를 적용하면 현재 상태에 따라 추가 전이를 제한할 수 있어 중복 처리의 영향을 줄일 수 있다.

> 앞서 학습한 Outbox 패턴은 메시지 유실을 줄이기 위한 전략이며, `Exactly-once` 문제와는 다른 층위의 해결책이다. 실무에서는 Outbox로 유실 가능성을 낮추고, `At-least-once`를 전제로 멱등성으로 중복을 흡수하는 방식이 일반적이다.

---

## 5. 정리

- 메시지 전달 보장 수준은 브로커 기능의 문제가 아니라 분산 시스템 구조의 문제다.
- 네트워크 경계와 트랜잭션 분리로 인해 `Exactly-once`를 완전하게 보장하는 것은 매우 어렵다.
- 실무에서는 `At-least-once`를 전제로 하고, **멱등성**과 **상태 기반 설계**를 통해 중복을 흡수하는 방식으로 정합성을 확보한다.
- `Exactly-once`는 기술적 기능이라기보다 시스템 전체가 합의해야 하는 속성에 가깝다.
