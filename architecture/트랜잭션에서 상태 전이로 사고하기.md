# 트랜잭션에서 상태 전이로 사고하기

## 날짜
- 2026-02-08

## 🎯 오늘의 주제
- 트랜잭션이 아닌 **상태 전이(State Transition)** 관점으로 흐름 재구성하기
- 실패 지점을 명시적으로 드러내는 사고 방식 연습


## 1. 상태 전이(State Transition) 관점의 사고 방식

> MSA 환경에서는 요청을 “하나의 트랜잭션”이 아니라  
> **여러 단계의 상태 전이 과정**으로 바라보는 것이 더 현실적이다.

트랜잭션 중심 사고에서는 성공은 커밋, 실패는 롤백으로 단순화된다. 
하지만 외부 시스템과 연동되는 MSA 환경에서는 부분 성공과 지연된 실패가 정상적으로 발생하며,
이때 중요한 것은 “되돌릴 수 있는가”가 아니라 **“지금 어떤 상태에 있는가”** 다.


## 2. 기본 상태 전이 모델
> ※ 본 문서는 도메인을 대출 서비스로 가정하고, 해당 도메인에서 발생할 수 있는 실패 지점을 식별하기 위한 예시를 사용한다.
### 2-1. 대출 신청 ~ 승인 전

**[흐름]**
- 대출 신청
- 계좌 인증 (외부)
- 신용점수 조회 (외부)

```text
신청됨
→ 인증중
→ 인증실패 / 인증완료
→ 심사중
→ 승인 / 거절
```

이 구간의 특징은 다음과 같다.
- 외부 의존성이 높다
- 실패 가능성이 항상 존재한다
- 실패 자체가 비즈니스적으로 자연스러운 상태다


### 2-2. 대출 승인 후

**[흐름]**
- 대출 승인
- 후속 처리 스케줄 데이터 생성 (내부 DB)
- 이후 정기적으로 스케줄러 실행
- 외부 집계 시스템에 **집계 정보 요청**
- 외부 집계 시스템 → 집계 결과 콜백
- 내부 상태 반영 (후속 상태)

```text
대출승인됨
→ 후속스케줄생성됨
→ 집계요청대기
→ 처리대기
→ 후속상태
```

이 단계부터는 단일 요청이 아니라 시간에 걸쳐 반복 실행되는 **장기 프로세스(Long-running process)** 로 전환된다.

## 3. 실패 지점 분석 (상태 전이 기준)
### 3-1. 외부 계좌 인증 단계

**[위치]**
- 대출 신청 직후
- 외부 계좌 인증 API 호출

**[발생 가능한 상황]**
- 외부 인증 서버 타임아웃
- 인증 서버 장애
- 응답 지연 또는 실패 응답

**[이미 성공한 것]**
- 대출 신청 데이터 내부 생성

**[문제]**
- 내부 상태가 `인증중`에서 멈춤
- 외부 인증 결과는 트랜잭션 롤백으로 되돌릴 수 없음

**[핵심 포인트]**
- 외부 인증 실패는 예외가 아니라 **정상적인 상태**
- `@Transactional`로 성공/실패를 정의할 수 없음


### 3-2. 외부 신용점수 조회 단계

**[위치]**
- 계좌 인증 완료 이후
- 외부 신용평가 기관 API 호출

**[발생 가능한 상황]**
- 신용점수 조회 실패
- 부분 응답 또는 불완전 응답

**[이미 성공한 것]**
- 계좌 인증 완료
- 대출 신청 상태는 `심사중`으로 전이

**[문제]**
- “심사 실패”와 “조회 실패”는 의미가 다름
- 실패 원인에 따라 서로 다른 상태 전이가 필요

**[핵심 포인트]**
- 실패의 종류에 따라 **다른 상태로 명시적 전이**
- 단순 롤백으로 표현 불가


### 3-3. 스케줄러 실행 중 외부 집계 시스템 호출 실패

**[위치]**
- 주기적으로 실행되는 스케줄러
- 외부 집계 시스템으로 집계 정보 요청

**[발생 가능한 상황]**
- 외부 시스템 타임아웃
- 네트워크 오류
- 요청 성공 여부 불확실

**[이미 성공한 것]**
- 후속 처리 스케줄 데이터는 이미 생성됨
- 요청 시점은 도래함

**[문제]**
- 요청이 실패했는지, 처리 중인지 판단 불가
- 재시도 시 중복 요청 위험 존재

**[핵심 포인트]**
- 스케줄러 작업은 트랜잭션 경계 밖
- 생성된 스케줄 데이터는 과거의 사실이므로 트랜잭션 롤백 대상이 아님
- 실패는 반드시 **상태로 남겨야 함**


### 3-4. 외부 집계 시스템 응답(콜백) 유실

**[위치]**
- 외부 집계 시스템 → 내부 서버 콜백

**[발생 가능한 상황]**
- 콜백 미도착
- 네트워크 장애
- 중복 콜백 수신

**[이미 성공한 것]**
- 첫 요청이 실제로는 성공했을 가능성

**[문제]**
- 중복 상태 전이
- 데이터 정합성 훼손 위험

**[핵심 포인트]**
- 트랜잭션은 “한 번만 처리됨”을 보장하지 못함
- 요청/응답 단위의 멱등성 고려 필요


### 3-5. 재시도로 인한 중복 처리

**[위치]**
- 외부 호출 실패 후 재시도 로직
- 콜백 재수신

**[발생 가능한 상황]**
- 동일 상환 집계 정보 요청 중복 전송
- 동일 콜백 중복 수신

**[이미 성공한 것]**
- 첫 요청이 실제로는 성공했을 가능성

**[문제]**
- 중복 상태 전이
- 데이터 정합성 훼손 위험

**[핵심 포인트]**
- 트랜잭션은 “한 번만 처리됨”을 보장하지 못함
- 요청/응답 단위의 멱등성 고려 필요


### 3-6. 실패 지점 요약

| 실패 지점        | 본질                |
| ------------ | ----------------- |
| 외부 인증 / 조회   | 외부 의존성으로 인한 부분 실패 |
| 승인 이후 단계     | 되돌릴 수 없는 비즈니스 결정  |
| 스케줄러 작업      | 트랜잭션 경계 외 작업      |
| 외부 집계 시스템 콜백 | 상태 불일치 발생 지점      |
| 재시도          | 중복 처리 위험          |


## 4. 정리

> MSA 환경에서는 트랜잭션 성공이 곧 비즈니스 성공이 아니다. 실패는 예외가 아니라 하나의 **상태**이며, 중요한 것은 롤백이 아니라 **다음 상태로의 전이**다.

> 트랜잭션에서 상태 전이로 사고를 전환하는 순간, 보상, 이벤트 기반 처리, 결과적 일관성 같은 접근이 자연스럽게 연결된다.
