# Saga 패턴과 보상 트랜잭션

## 날짜
- 2026-02-12

## 🎯 오늘의 주제
- 보상 트랜잭션(Compensating Transaction)의 개념 이해
- DB 롤백과 보상의 차이 구분
- 분산 환경에서 실패 이후 흐름 설계

---

## 1. 보상 트랜잭션의 정의

보상 트랜잭션(Compensating Transaction)은 이미 성공한 작업을 **비즈니스 관점에서 되돌리는 동작**이다. 이는 DB 레벨의 롤백과는 근본적으로 다르다.
DB 롤백은 동일한 트랜잭션 경계 안에서 아직 확정되지 않은 변경 사항을 취소하는 행위이지만, 보상은 이미 커밋이 완료된 상태를 전제로 한다.

### 1-1. DB 롤백과의 차이

| 구분 | DB 롤백 | 보상 트랜잭션 |
|------|----------|----------------|
| 적용 범위 | 단일 트랜잭션 | 여러 서비스에 걸친 흐름 |
| 시점 | 트랜잭션 종료 직전 | 이후 단계 실패 시 |
| 방식 | 데이터 원복 | 새로운 취소/보정 작업 수행 |
| 완전성 | 완전 원복 | 부분 보정 가능 |

DB 롤백은 같은 트랜잭션 경계 안에서만 가능하지만, 보상 트랜잭션은 **이미 커밋된 상태를 전제로 한다.**

---

## 2. 보상이 필요한 이유

Saga 패턴에서는 다음이 전제된다.

- 각 서비스는 로컬 트랜잭션만 보장한다.
- 전체 흐름은 여러 단계로 구성된다.
- 중간 실패는 항상 발생할 수 있으며, 이는 예외가 아니다.

이 구조에서는 전체를 하나로 롤백하는 것이 불가능하다. 대신 이미 성공한 작업을 어떻게 처리할 것인지 명시적으로 설계해야 한다.
즉, 보상은 실패 이후의 흐름을 정의하는 설계 요소다.

---

## 3. 보상의 구조적 특징

### 3-1. 보상은 대칭적이지 않을 수 있다

원래 작업과 보상 작업이 완전히 대칭 구조를 이루는 경우도 있지만, 그러지 않은 경우도 많다.

> e.g.
> - 결제 성공 → 보상은 결제 취소
> - 재고 차감 → 보상은 재고 복구

그러나 일부 작업은 완전한 원복이 불가능할 수도 있다. (e.g. 외부 시스템에 이미 전파된 이벤트나 알림)

### 3-2. 보상도 실패할 수 있다

보상 트랜잭션도 하나의 비즈니스 작업이기 때문에 다음과 같은 위험을 가진다.

- 네트워크 실패
- 외부 API 실패
- 중복 요청
- 순서 역전 (out-of-order execution)

즉, 보상은 안전 장치이지만 절대적으로 안전하지는 않다. 따라서 보상 서계 시에는 멱등성 보장과 재시도 전략이 필수적으로 고려되어야 한다.

### 3-3. 상태 전이 중심 설계가 필요하다

보상은 단순 메서드 호출이 아니라 상태 전이의 일부로 다뤄져야 한다.
예를 들어 다음과 같은 상태 모델을 생각할 수 있다.

> e.g.
> 처리중 → 실패 → 보상중 → 보상완료

이처럼 보상 단계를 명시적으로 상태에 반영해야 운영과 모니터링이 가능하다.
보상이 성공했는지, 진행 중인지, 재시도가 필요한지 추적할 수 있어야 하기 때문이다.

---

## 4. 도메인 관점에서의 적용 예시

하나의 비즈니스 흐름이 다음과 같이 구성된다고 가정해보자.

1. 결제 승인
2. 대출 생성
3. 알림 발송

이때 2번 단계에서 실패가 발생한다면 이미 완료된 1번 작업을 그대로 둘 것인지, 아니면 취소할 것인지를 결정해야 한다.

- 1번 결제 승인에 대해 취소 요청 수행
- 상태를 “보상중”으로 변경
- 성공 시 “보상완료” 상태로 전이

이 과정에서 중요한 점은 과거를 지우는 것이 아니라, 현재 상태를 비즈니스적으로 정리하는 것이라는 점이다.

---

## 5. 보상 설계 시 고려 사항

보상 트랜잭션을 설계할 때는 단순히 취소 API를 호출한다 수준으로 끝나지 않는다. 다음과 같은 질문이 함께 따라온다.

- 보상은 반드시 역순으로 실행되어야 하는가?
- 일부 단계만 보상하고 나머지는 유지할 수 있는가?
- 보상 실패 시 재시도 정책은 어디서 관리하는가?
- 여러 단계가 동시에 실패했을 경우 보상 순서는 어떻게 보장하는가?

특히 분산 환경에서는 메시지 지연이나 순서 역전이 발생할 수 있기 때문에, 보상 로직이 특정 순서에 강하게 의존하도록 설계하는 것은 위험하다.
또한 보상이 반복 실행되더라도 결과가 동일하게 유지되도록 멱등성을 확보하는 것이 중요하다. 그렇지 않으면 보상을 위한 보상이 계속 발생하는 악순환에 빠질 수 있다.

---

## 6. 정리

- 보상 트랜잭션은 DB 롤백과는 전혀 다른 개념이다.
- 보상은 이미 커밋된 비즈니스 행위를 다시 다루는 작업이며, 실패 이후의 흐름을 설계하는 핵심 요소다.
- 보상 역시 실패할 수 있고, 멱등성과 상태 전이 설계가 동반되지 않으면 오히려 복잡도를 증가시킬 수 있다.
- Saga 패턴의 본질은 모든 작업을 성공시키는 것이 아니라, 실패가 발생하더라도 통제 가능한 흐름 안에서 정리할 수 있도록 만드는 데 있다.
